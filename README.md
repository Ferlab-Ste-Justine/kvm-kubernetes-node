# About

This package provisions a node (master or worker) that you can install Kubernetes on (validated with Kubespray).

The implementation is currently quite minimalistic and beyond enabling IPv4 forwarding, doesn't really do any Kubernetes-specific setup.

# Usage

## Input

The module takes the following variables as input:

- **`name`**: Name of the load balancer VM.
- **`vcpus`**: Number of vCPUs to assign to the load balancer. Defaults to 2.
- **`memory`**: Amount of memory to assign to the bastion in MiB. Defaults to 8192 (8 GiB).
- **`volume_id`**: ID of the disk volume to attach to the VM.
- **`libvirt_network`**: Parameters to connect to libvirt networks. Each entry has the following keys:
  - **`network_id`**: ID (i.e., UUID) of the libvirt network to connect to (in which case **network_name** should be an empty string).
  - **`network_name`**: Name of the libvirt network to connect to (in which case **network_id** should be an empty string).
  - **`ip`**: IP of the interface connecting to the libvirt network.
  - **`mac`**: MAC address of the interface connecting to the libvirt network.
  - **`prefix_length`**: Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** network, this would be **24**.
  - **`gateway`**: IP of the network's gateway. Usually, the first assignable address of a libvirt network.
  - **`dns_servers`**: DNS servers to use. Usually, the DNS server is the first assignable address of a libvirt network.
- **`macvtap_interfaces`**: List of macvtap interfaces to connect the VM to if you opt for macvtap interfaces. Each entry in the list is a map with the following keys:
  - **`interface`**: Host network interface that you plan to connect your macvtap interface with.
  - **`prefix_length`**: Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** network, this would be **24**.
  - **`ip`**: IP associated with the macvtap interface. 
  - **`mac`**: MAC address associated with the macvtap interface.
  - **`gateway`**: IP of the network's gateway for the network the interface will be connected to.
  - **`dns_servers`**: DNS servers for the network the interface will be connected to. If there aren't DNS servers set up for the network your VM will connect to, the IP of external DNS servers accessible from the network will work as well.
- **`cloud_init_volume_pool`**: Name of the volume pool that will contain the cloud-init volume of the VM.
- **`cloud_init_volume_name`**: Name of the cloud-init volume that will be generated by the module for your VM. If left empty, it will default to ``<vm name>-cloud-init.iso``.
- **`ssh_admin_user`**: Username of the default sudo user in the image. Defaults to **ubuntu**.
- **`admin_user_password`**: Optional password for the default sudo user of the image. Note that this will not enable SSH password connections, but it will allow you to log into the VM from the host using the **virsh console** command.
- **`ssh_admin_public_key`**: Public part of the SSH key that will be used to log in as the admin on the VM.
- **`docker_registry_auth`**: Optional Docker registry authentication settings to have access to private repositories or to avoid reaching the rate limit for anonymous users.
  - **`enabled`**: If set to false (the default), no Docker config file will be created.
  - **`url`**: URL of the registry you want to authenticate to.
  - **`username`**: Username for the authentication.
  - **`password`**: Password for the authentication.
- **`nfs_tunnel`**: Configuration for an optional forwarder to an NFS server using a TLS tunnel to be placed on Kubernetes workers. It takes the following properties:
  - **`enabled`**: Whether to enable the tunnel setup. It is disabled by default.
  - **`server_domain`**: The domain of the NFS server.
  - **`server_port`**: Port that the other side of the tunnel on the server will listen on.
  - **`client_key`**: TLS private key to authenticate the client.
  - **`client_certificate`**: TLS certificate to authenticate the client.
  - **`ca_certificate`**: CA certificate to authenticate the server.
  - **`nameserver_ips`**: Optional IPs of nameservers used to resolve the NFS server domain.
- **`fluentbit`**: Optional Fluent-bit configuration to securely route logs to a Fluent-bit node using the forward plugin. Alternatively, configuration can be 100% dynamic by specifying the parameters of an etcd store to fetch the configuration from. It has the following keys:
  - **`enabled`**: If set to false (the default), Fluent-bit will not be installed.
  - **`nfs_tunnel_client_tag`**: Tag to assign to logs coming from the NFS tunnel client.
  - **`containerd_tag`**: Tag to assign to logs coming from containerd. Relevant for both masters and workers.
  - **`kubelet_tag`**: Tag to assign to logs coming from kubelet. Relevant for both masters and workers.
  - **`etcd_tag`**: Tag to assign to logs coming from etcd. Should be set to an empty string on worker nodes to disable it, as etcd will only be present on master nodes.
  - **`node_exporter_tag`**: Tag to assign to logs coming from the Prometheus node exporter.
  - **`forward`**: Configuration for the forward plugin that will talk to the external Fluent-bit node. It has the following keys:
    - **`domain`**: IP or domain name of the remote Fluent-bit node.
    - **`port`**: Port the remote Fluent-bit node listens on.
    - **`hostname`**: Unique hostname identifier for the VM.
    - **`shared_key`**: Secret shared key with the remote Fluent-bit node to authenticate the client.
    - **`ca_cert`**: CA certificate that signed the remote Fluent-bit node's server certificate (used to authenticate it).
  - **`etcd`**: Parameters to fetch Fluent-bit configurations dynamically from an etcd cluster. It has the following keys:
    - **`enabled`**: If set to true, configurations will be set dynamically. The default configurations can still be referenced as needed by the dynamic configuration. They are at the following paths:
      - **Global Service Configs**: /etc/fluent-bit-customization/default-config/fluent-bit-service.conf
      - **Systemd Inputs**: /etc/fluent-bit-customization/default-config/fluent-bit-inputs.conf
      - **Forward Output**: /etc/fluent-bit-customization/default-config/fluent-bit-output.conf
    - **`key_prefix`**: Etcd key prefix to search for Fluent-bit configuration.
    - **`endpoints`**: Endpoints of the etcd cluster. Endpoints should have the format `<ip>:<port>`.
    - **`ca_certificate`**: CA certificate against which the server certificates of the etcd cluster will be verified for authenticity.
    - **`client`**: Client authentication. It takes the following keys:
      - **`certificate`**: Client TLS certificate to authenticate with. To be used for certificate authentication.
      - **`key`**: Client private TLS key to authenticate with. To be used for certificate authentication.
      - **`username`**: Client's username. To be used for username/password authentication.
      - **`password`**: Client's password. To be used for username/password authentication.
- **`chrony`**: Optional Chrony configuration for when you need a more fine-grained NTP setup on your VM. It is an object with the following fields:
  - **`enabled`**: If set to false (the default), Chrony will not be installed and the VM NTP settings will be left to default.
  - **`servers`**: List of NTP servers to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#server).
  - **`pools`**: A list of NTP server pools to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#pool).
  - **`makestep`**: An object containing remedial instructions if the clock of the VM is significantly out of sync at startup. It is an object containing two properties, **threshold** and **limit** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#makestep).
- **`install_dependencies`**: Whether cloud-init should install external dependencies (should be set to false if you already provide an image with the external dependencies built-in).

## Vault Agent Configuration

- **`vault_agent`**: Configuration for Vault Agent. This includes enabling the Vault Agent, specifying an authentication method, and defining templates for rendering secrets. It has the following fields:
  - **`enabled`**: Whether to enable the Vault Agent.
  - **`install_dependencies`**: Whether to install Vault Agent dependencies.
  - **`auth_method`**: Configuration for the Vault authentication method.
    - **`type`**: Authentication method type (e.g., "approle").
    - **`config`**: Configuration for the selected authentication method, including:
      - **`role_id`**: Role ID content.
      - **`secret_id`**: Secret ID content.
  - **`vault_address`**: Address of the Vault server.
  - **`vault_ca_cert`**: CA certificate content for Vault.
  - **`templates`**: List of templates for rendering secrets.
    - **`source_path`**: Source template path.
    - **`destination_path`**: Destination path for rendered secrets.
    - **`service_name`**: Service to reload after rendering secrets.
    - **`secret_path`**: Vault secret path to retrieve.
    - **`secret_key`**: Specific key in the secret to retrieve.
  - **`agent_config`**: Additional Vault Agent configuration (if any).
  - **`release_version`**: Version of the Vault Agent to install.

## Output

The module exports:
- **`ip`**: The IP address of the provisioned VM.
- **`id`**: The VM instance ID.
- **`groups`**: Security groups associated with the VM.
